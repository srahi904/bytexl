// server.js
const express = require("express");
const mongoose = require("mongoose");

const app = express();
app.use(express.json());

// ==================== 1ï¸âƒ£ Connect MongoDB ====================
mongoose
  .connect("mongodb://127.0.0.1:27017/bankdb", {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => console.log("âœ… MongoDB Connected"))
  .catch((err) => console.error("âŒ MongoDB Error:", err));

// ==================== 2ï¸âƒ£ Define User Schema ====================
const userSchema = new mongoose.Schema({
  name: String,
  balance: Number,
});

const User = mongoose.model("User", userSchema);

// ==================== 3ï¸âƒ£ Transfer Route ====================
app.post("/transfer", async (req, res) => {
  const { fromUser, toUser, amount } = req.body;

  // Input validation
  if (!fromUser || !toUser || !amount || amount <= 0) {
    return res
      .status(400)
      .json({ error: "Invalid input. Provide fromUser, toUser, and positive amount." });
  }

  try {
    // Step 1: Fetch both accounts
    const sender = await User.findOne({ name: fromUser });
    const receiver = await User.findOne({ name: toUser });

    if (!sender || !receiver) {
      return res.status(404).json({ error: "Sender or receiver account not found." });
    }

    // Step 2: Check balance
    if (sender.balance < amount) {
      return res.status(400).json({ error: "Insufficient balance." });
    }

    // Step 3: Sequential Updates (logical correctness)
    sender.balance -= amount;
    await sender.save();

    receiver.balance += amount;
    await receiver.save();

    res.json({
      message: "Transfer successful",
      from: sender.name,
      to: receiver.name,
      amount,
      senderNewBalance: sender.balance,
      receiverNewBalance: receiver.balance,
    });
  } catch (err) {
    console.error("Transfer Error:", err);
    res.status(500).json({ error: "Internal Server Error" });
  }
});

// ==================== 4ï¸âƒ£ Helper Routes ====================

// Create sample users
app.post("/seed", async (req, res) => {
  await User.deleteMany({});
  const users = await User.insertMany([
    { name: "Alice", balance: 1000 },
    { name: "Bob", balance: 500 },
  ]);
  res.json({ message: "Sample users created", users });
});

// View all users
app.get("/users", async (req, res) => {
  const users = await User.find();
  res.json(users);
});

// ==================== 5ï¸âƒ£ Start Server ====================
const PORT = 3000;
app.listen(PORT, () => console.log(`ðŸš€ Server running on http://localhost:${PORT}`));
